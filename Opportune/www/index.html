<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<meta http-equiv="Content-type" content="text/html; charset=utf-8">
		<link rel="stylesheet" href="css/ratchet.css"/>
		<!-- Libs -->
		<script src="lib/jquery/jquery-2.0.0.min.js"></script>
		<script src="lib/backbone/underscore-1.4.4.min.js"></script>
		<script src="lib/backbone/backbone-1.0.0.min.js"></script>
		<script src="lib/cordova-2.3.0.js"></script>
		<script src="lib/forcetk.mobilesdk.js"></script>
		<script src="lib/cordova.force.js"></script>
		<script src="lib/smartsync.js"></script>
		<script src="lib/fastclick.js"></script>
		<script src="lib/stackrouter.js"></script>
		
		<!-- App -->
		<script src="init.js"></script>
		<script src="app/models/OfflineTracker.js"></script>
	</head>
  <body>
  	<div id="content"></div>
  	<!-- 
  		Templates 
  	-->
  	<!-- Search Page -->
  	<script id="search-page" type="text/template">
			<header class="bar-title">
				<h1 class="title">Users</h1>
			</header>
			<div class="bar-standard bar-header-secondary">
				<input type="search" class="search-key" placeholder="Search"/>
			</div>
			<div class="content">
				<ul class="list"></ul>
			</div>
  	</script>

		<!-- List Item -->
		<script id="user-list-item" type="text/template">
			<img src="<%= SmallPhotoUrl %>" class="small-img" />
			<div class="details-short">
				<b><%= FirstName %> <%= LastName %></b><br/>
				Title<%= Title %>
			</div>
		</script>

  	<!-- App Init -->
  	<script>

			/**
			 * Models
			 **/

			//Define the User Model
			app.models.User = Force.SObject.extend({
    		sobjectType: "User",
    		fieldlist: ["Id", "FirstName", "LastName", "SmallPhotoUrl", "Title", "Email","MobilePhone","City"]
			});

			//Define the User Collection
			app.models.UserCollection = Force.SObjectCollection.extend({
    		model: app.models.User
			});

			/**
			 * Views
			 **/
			//search page
			app.views.SearchPage = Backbone.View.extend({
			 	template: _.template($("#search-page").html()),
				initialize: function() {
					this.listView = new app.views.UserListView({model: this.model});
				},
				render: function(eventName) {
					$(this.el).html(this.template());
					$(".search-key", this.el).val(this.model.criteria);
					this.listView.setElement($("ul", this.el)).render();
					return this;
				},	
				events: {
					"keyup .search-key": "search"
				},
				search: function(event) {
					this.model.criteria = $(".search-key", this.el).val();
					var soql = "SELECT Id, FirstName, LastName, SmallPhotoUrl, Title FROM User WHERE Name like '" + this.model.criteria + "%' ORDER BY Name LIMIT 25 ";
					this.model.fetch({config: {type:"soql", query:soql}});
				}				
			});

			//results list view
			app.views.UserListView = Backbone.View.extend({
				listItemViews: [],
				initialize: function() {
					this.model.bind("reset", this.render, this);
				},
				render: function(eventName) {
 					_.each(this.listItemViews, function(itemView) { itemView.close(); });

					this.listItemViews = _.map(this.model.models, function(model) { 
						return new app.views.UserListItemView({model: model});
					});

					$(this.el).append(_.map(this.listItemViews, function(itemView) {
						return itemView.render().el;
					}));
					
					return this;
				}
			});

			app.views.UserListItemView = Backbone.View.extend({
				tagName: "li",
				template: _.template($("#user-list-item").html()),
				render: function(eventName) {
					$(this.el).html(this.template(this.model.toJSON()));
					return this;
				},
				close: function() {
					this.remove();
					this.off();
				}
			});

			/**
			 * Router
			 **/

			app.Router = Backbone.Router.extend({
				routes: {
    			"": "list"
				},
				initialize: function() {
    			Backbone.Router.prototype.initialize.call(this);
    			// Collection behind search screen
    			app.searchResults = new app.models.UserCollection();
    			app.searchView = new app.views.SearchPage({model: app.searchResults});
				},
				list: function() {
					app.searchResults.fetch();
					$('#content').html(app.searchView.render().el);
				}
			});
		</script>
	</body>
</html>